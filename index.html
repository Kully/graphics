<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>MINECRAFT</title>

	<style type="text/css">
		#my-canvas {
			outline: 1px solid black;
		}

		#my-canvas-2 {
			outline: 1px solid green;
		}
	</style>
</head>

<body>
	<canvas id="my-canvas" width="600" height="400"></canvas>
	<canvas id="my-canvas-2" width="600" height="400"></canvas>
</body>


<script type="text/javascript">
	let canvas = document.getElementById("my-canvas");
	let ctx = canvas.getContext("2d");

	let canvas2 = document.getElementById("my-canvas-2");
	let ctx2 = canvas2.getContext("2d");

	const WIDTH = 600;
	const HEIGHT = 400;
	const FPS = 60;

	const WHITE = "rgb(255,255,255)";
	const SCREEN_CLEAR = "#EEEEEE";
	const FLOOR_COLOR = "#334257";
	const WALL_COLOR  = "#548CA8";
	const EVENT_CODES = [
		"ArrowLeft",
		"ArrowRight",
		"ArrowUp",
		"ArrowDown",
		"KeyA",
		"KeyD",
	];

	const two_pi = 2 * Math.PI;
	const visionSpread = Math.PI/2;
	const rotateAngle = Math.PI/32;
	const drawDistance = 80;

	const CONTROLLER = {
		ArrowDown: 0,
		ArrowUp: 0,
		ArrowLeft: 0,
		ArrowRight: 0,
		KeyA: 0,
		KeyD: 0,
	}
	const INPUT_TIMER = {
		ArrowDown: 0,
		ArrowUp: 0,
		ArrowLeft: 0,
		ArrowRight: 0,
		KeyA: 0,
		KeyD: 0,
	}
	const PLAYER = {
		x: WIDTH/2+10,
		y: HEIGHT/2,
		w: 10,
		h: 10,
		color: "#D54C4C",
		angle: 0,
	};
	let enemy = {
		x: WIDTH/2 + 20,
		y: HEIGHT/2 - 35,
		z: 300,
		w: 20,
		h: 20,
	};

	function clearScreen()
	{
		ctx.fillStyle = SCREEN_CLEAR;
		ctx.fillRect(0, 0, WIDTH, HEIGHT);
	}

	function clearScreen_2()
	{
		ctx2.fillStyle = SCREEN_CLEAR;
		ctx2.fillRect(0, 0, WIDTH, HEIGHT);
	}

	function drawPlayer_2()
	{
		ctx2.fillStyle = PLAYER["color"];
		ctx2.fillRect(PLAYER["x"], PLAYER["y"], PLAYER["w"], PLAYER["h"]);
	}

	function drawEnemy_2()
	{
		for(en of [enemy])
		{
			ctx2.fillStyle = en["color"];
			ctx2.fillRect(
				en["x"],
				en["y"],
				en["w"],
				en["h"]
			);
		}
	}

	function insideEnemy(pos_x, pos_y, enemy)
	{
		for(i=enemy["x"]; i<enemy["x"]+enemy["w"]; i++)
			for(j=enemy["y"]; j<enemy["y"]+enemy["h"]; j++)
			{
				if(pos_x === i && pos_y === j)
				{
					return true;
				}
			}
		return false;
	}

	function movePlayer()
	{
		if(CONTROLLER["ArrowLeft"] === 1)
		{
			PLAYER["x"] -= Math.cos(PLAYER["angle"] + visionSpread);
			PLAYER["y"] -= Math.sin(PLAYER["angle"] + visionSpread);
		}
		if(CONTROLLER["ArrowRight"] === 1)
		{
			PLAYER["x"] += Math.cos(PLAYER["angle"] + visionSpread);
			PLAYER["y"] += Math.sin(PLAYER["angle"] + visionSpread);
		}
		if(CONTROLLER["ArrowUp"] === 1)
		{
			PLAYER["x"] += Math.cos(PLAYER["angle"] + visionSpread - Math.PI / 2);
			PLAYER["y"] += Math.sin(PLAYER["angle"] + visionSpread - Math.PI / 2);
		}
		if(CONTROLLER["ArrowDown"] === 1)
		{
			PLAYER["x"] -= Math.cos(PLAYER["angle"] + visionSpread - Math.PI / 2);
			PLAYER["y"] -= Math.sin(PLAYER["angle"] + visionSpread - Math.PI / 2);
		}
	}

	function rotatePlayer()
	{
		if(CONTROLLER["KeyA"] === 1)
		{
			PLAYER["angle"] -= rotateAngle;
			PLAYER["angle"] %= (two_pi);
		}
		if(CONTROLLER["KeyD"] === 1)
		{
			PLAYER["angle"] += rotateAngle;
			PLAYER["angle"] %= (two_pi);
		}
	}

	document.addEventListener("keydown", function(e) {

		for(code of EVENT_CODES)
		{
			if(e.code === code)
			{
				CONTROLLER[code] = 1;
				INPUT_TIMER[code] += 1;
			}	
		}
	})

	document.addEventListener("keyup", function(e) {

		for(code of EVENT_CODES)
		{
			if(e.code === code)
			{
				CONTROLLER[code] = 0;
				INPUT_TIMER[code] = 0;
			}
		}
	})

	setInterval(function(e) {
		movePlayer();
		rotatePlayer();

		// Figure out what the POV should look like
		let angle_incr = (visionSpread) / WIDTH;
		let rel_heights = [];
		for(
			angle = PLAYER["angle"] - visionSpread / 2;
			angle < PLAYER["angle"] + visionSpread / 2;
			angle += angle_incr)
		{
			let depthReached = 10000000;
			for(let d=0; d<drawDistance; d++)
			{
				let pos_vector = [
					PLAYER["x"] + ( Math.cos(angle) ) * d,
					PLAYER["y"] + ( Math.sin(angle) ) * d
				]

				pos_vector[0] = parseInt(pos_vector[0]);
				pos_vector[1] = parseInt(pos_vector[1]);

				if(insideEnemy(pos_vector[0], pos_vector[1], enemy))
				{
					depthReached = Math.min(d, depthReached);
				}
			}
			rel_heights.push(depthReached);
		}

		clearScreen();
		ctx.fillStyle = FLOOR_COLOR
		ctx.fillRect(0, HEIGHT/2, WIDTH, HEIGHT / 2);

		ctx.fillStyle = WALL_COLOR;
		for(k=0; k<WIDTH; k+=1)
		{
			let enemyHeight = enemy["z"] / rel_heights[k] * (HEIGHT / drawDistance);
			let y_pos = (HEIGHT - enemyHeight) / 2
			ctx.fillRect(k, y_pos, 1, enemyHeight);
		}

		// draw bird's eye view for debugging
		clearScreen_2();
		drawPlayer_2();
		drawEnemy_2();
	}, 1000 / FPS)

</script>

</html>